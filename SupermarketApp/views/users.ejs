<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Users - Supermarket App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body class="bg-light d-flex flex-column min-vh-100">
  <%- include("partials/navbar", { user: user }) %>

  <main class="container py-4 flex-grow-1">
    <% if (errors && errors.length) { %>
      <div class="alert alert-danger">
        <% errors.forEach(function(e){ %><div><%= e %></div><% }); %>
      </div>
    <% } %>

    <% if (messages && messages.length) { %>
      <div class="alert alert-success">
        <% messages.forEach(function(m){ %><div><%= m %></div><% }); %>
      </div>
    <% } %>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <p class="text-uppercase text-muted small mb-1">Management</p>
        <h2 class="mb-0 fw-bold">Users</h2>
      </div>
      <a href="/inventory" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2">
        <span class="bi bi-arrow-left-circle"></span> Back to Inventory
      </a>
    </div>

    <div class="card shadow-sm border-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col" class="text-muted text-uppercase small">ID</th>
              <th scope="col" class="text-muted text-uppercase small">Username</th>
              <th scope="col" class="text-muted text-uppercase small">Email</th>
              <th scope="col" class="text-muted text-uppercase small">Address</th>
              <th scope="col" class="text-muted text-uppercase small">Contact</th>
              <th scope="col" class="text-muted text-uppercase small">Role</th>
              <th scope="col" class="text-muted text-uppercase small">Status</th>
              <th scope="col" class="text-end text-muted text-uppercase small" style="width:260px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (!users || !users.length) { %>
              <tr>
                <td colspan="8" class="text-center py-4 text-muted">No users found.</td>
              </tr>
            <% } else { %>
              <% users.forEach(function(u, idx){ 
                   const disabled = !!u.is_disabled;
                   const roleLabel = u.role === 'disabled' ? 'user' : u.role;
              %>
                <tr>
                  <td><%= idx + 1 %></td>
                  <td><%= u.username %></td>
                  <td><%= u.email %></td>
                  <td><%= u.address %></td>
                  <td><%= u.contact %></td>
                  <td><span class="badge <%= roleLabel === 'admin' ? 'bg-primary' : 'bg-secondary' %>"><%= roleLabel %></span></td>
                  <td>
                    <span class="badge <%= disabled ? 'bg-secondary' : 'bg-success' %>">
                      <%= disabled ? 'disabled' : 'active' %>
                    </span>
                  </td>
                  <td class="text-end" style="min-width: 320px;">
                    <div class="d-flex justify-content-end align-items-center gap-2 flex-nowrap">
                      <form action="/users/role/<%= u.id %>" method="POST" class="d-flex align-items-center gap-2 flex-nowrap mb-0">
                        <select name="role" class="form-select form-select-sm w-auto" <%= disabled ? 'disabled' : '' %>>
                          <option value="user" <%= roleLabel === 'user' ? 'selected' : '' %>>User</option>
                          <option value="admin" <%= roleLabel === 'admin' ? 'selected' : '' %>>Admin</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1" <%= disabled ? 'disabled' : '' %>>
                          <i class="bi bi-arrow-repeat"></i><span>Update Role</span>
                        </button>
                      </form>
                      <form action="/users/toggle/<%= u.id %>" method="POST" class="d-flex align-items-center mb-0">
                        <input type="hidden" name="action" value="<%= disabled ? 'enable' : 'disable' %>">
                        <button type="submit" class="btn btn-sm <%= disabled ? 'btn-success' : 'btn-warning' %> d-flex align-items-center gap-1" onclick="return confirm('<%= disabled ? 'Enable this user?' : 'Disable this user?' %>');" <%= (user && user.id === u.id) ? 'disabled' : '' %>>
                          <i class="bi <%= disabled ? 'bi-unlock' : 'bi-lock' %>"></i><span><%= disabled ? 'Enable' : 'Disable' %></span>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% }); %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <%- include("partials/footer") %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
