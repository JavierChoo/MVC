<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Order #<%= order.id %> Details</title>
  <style>
    @media print {
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>
  <%- include("partials/navbar", { user: user }) %>

  <div class="container py-4">
    <% if (errors && errors.length) { %>
      <div class="alert alert-danger">
        <% errors.forEach(function(e){ %><div><%= e %></div><% }); %>
      </div>
    <% } %>

    <% if (messages && messages.length) { %>
      <div class="alert alert-success">
        <% messages.forEach(function(m){ %><div><%= m %></div><% }); %>
      </div>
    <% } %>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-1">Order #<%= order.id %></h2>
        <div class="text-muted">Placed: <%= (new Date(order.created_at)).toLocaleString() %></div>
      </div>
      <div class="no-print">
        <a href="/orders" class="btn btn-secondary me-2">Back to Orders</a>
        <button class="btn btn-outline-primary" onclick="window.print()">Print</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <div class="fw-bold">Customer</div>
            <div><%= order.customerName || (user && user.username) || 'Customer' %></div>
            <div class="text-muted"><%= order.customerEmail || (user && user.email) || '' %></div>
            <% if (order.customerAddress) { %>
              <div class="text-muted"><%= order.customerAddress %></div>
            <% } %>
          </div>
          <div class="text-end">
            <div class="fw-bold">Order Total</div>
            <div class="h5 mb-0">$<%= (order.total || 0).toFixed(2) %></div>
          </div>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">Product</th>
            <th scope="col" style="width:120px;">Price</th>
            <th scope="col" style="width:120px;">Quantity</th>
            <th scope="col" style="width:140px;">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          <% let total = 0; %>
          <% if (items && items.length) { %>
            <% items.forEach(function(item){ 
                 const price = Number(item.price || 0);
                 const qty = Number(item.quantity || 0);
                 const subtotal = price * qty;
                 total += subtotal;
            %>
              <tr>
                <td>
                  <% 
                    const name = item.productName || ('Product #' + item.product_id);
                    const cleanName = name.replace(/\s*\(deleted\)\s*$/i, '');
                  %>
                  <%= cleanName %>
                </td>
                <td>$<%= price.toFixed(2) %></td>
                <td><%= qty %></td>
                <td>$<%= subtotal.toFixed(2) %></td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="4" class="text-center text-muted">No items found for this order.</td>
            </tr>
          <% } %>
        </tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="text-end">Total</th>
            <th>$<%= total.toFixed(2) %></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
