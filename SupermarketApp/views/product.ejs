<!-- product.ejs -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= product ? product.productName : 'Product' %> - Supermarket App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light d-flex flex-column min-vh-100">

  <%- include("partials/navbar", { user: user }) %>

  <main class="container py-4 flex-grow-1">
    <% if (errors && errors.length) { %>
      <div class="alert alert-danger">
        <% errors.forEach(function(e){ %><div><%= e %></div><% }); %>
      </div>
    <% } %>

    <% if (messages && messages.length) { %>
      <div class="alert alert-success">
        <% messages.forEach(function(m){ %><div><%= m %></div><% }); %>
      </div>
    <% } %>

    <div class="card shadow-sm">
      <div class="card-body">
        <% if (!product) { %>
          <div class="text-center py-5">
            <h5 class="mb-3">Product not found</h5>
            <a href="<%= user && user.role === 'admin' ? '/inventory' : '/shopping' %>" class="btn btn-secondary">Back</a>
          </div>
        <% } else { %>
          <div class="row g-4">
            <div class="col-12 col-md-5">
              <% 
                const imgSrc = product.image
                  ? (typeof product.image === 'string' && product.image.startsWith('/') ? product.image : '/images/' + product.image)
                  : '/images/default.png';
                const outOfStock = product.isOutOfStock || product.quantity === 0;
              %>
              <img src="<%= imgSrc %>" alt="<%= product.productName %>" class="img-fluid rounded w-100" style="object-fit:cover; max-height:420px;">
            </div>

            <div class="col-12 col-md-7">
              <h3 class="mb-2"><%= product.productName %></h3>
              <p class="text-muted mb-2">Price: <span class="fw-semibold">$<%= (product.price || 0).toFixed(2) %></span></p>
              <p class="mb-2">
                Available: <%= product.quantity %>
                <% if (outOfStock) { %>
                  <span class="badge bg-danger ms-2">Out of Stock</span>
                <% } %>
              </p>
              <% if (outOfStock) { %>
                <div class="alert alert-warning py-2 px-3 mb-3">
                  This product is currently out of stock and cannot be added to your cart.
                </div>
              <% } %>

              <% if (user && user.role === 'admin') { %>
                <div class="d-flex gap-2">
                  <a href="/updateProduct/<%= product.id %>" class="btn btn-warning">Edit</a>
                  <a href="/deleteProduct/<%= product.id %>" class="btn btn-danger" onclick="return confirm('Delete this product?');">Delete</a>
                  <a href="/inventory" class="btn btn-outline-secondary">Back to Inventory</a>
                </div>
              <% } else { %>
                <form action="/add-to-cart/<%= product.id %>" method="POST" class="row g-2 align-items-center">
                  <div class="col-auto">
                    <label for="quantity" class="visually-hidden">Quantity</label>
                    <select id="quantity" name="quantity" class="form-select form-select-sm" style="min-width:90px;" <%= outOfStock ? 'disabled' : '' %>>
                      <% for (let q = 1; q <= Math.min(10, product.quantity || 10); q++) { %>
                        <option value="<%= q %>"><%= q %></option>
                      <% } %>
                    </select>
                  </div>

                  <div class="col-auto">
                    <% if (outOfStock) { %>
                      <button type="button" class="btn btn-secondary" disabled>Out of Stock</button>
                    <% } else { %>
                      <button type="submit" class="btn btn-primary">Add to Cart</button>
                    <% } %>
                  </div>

                  <div class="col-12 mt-3">
                    <a href="/shopping" class="btn btn-link">Back to Shopping</a>
                  </div>
                </form>
              <% } %>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </main>

  <%- include("partials/footer") %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
